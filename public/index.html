<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiRace</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="page">
        <main class="page-content">
            <div class="container">
                <div id="animatedTitle"></div>
                <div class="card">
                    <form id="joinForm" class="form">
                        <div class="form-group">
                            <label class="form-label" for="roomId">Room ID</label>
                            <input type="text" id="roomId" class="form-input" required
                                   pattern="[A-Z0-9]{4}" maxlength="4"
                                   placeholder="Enter 4-character room ID">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="playerName">Your Name</label>
                            <input type="text" id="playerName" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Role</label>
                            <div class="icon-button-group">
                                <button type="button" class="icon-button active" data-value="player">
                                    <i class="fas fa-user"></i>
                                    <span>Player</span>
                                </button>
                                <button type="button" class="icon-button" data-value="observer">
                                    <i class="fas fa-eye"></i>
                                    <span>Observer</span>
                                </button>
                                <input type="hidden" name="role" value="player">
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="button">Join Room</button>
                        </div>
                    </form>
                </div>

                <div class="button-group" id="createRoomButton" style="display: none;">
                    <a href="/create" class="button button-secondary button-small">Create Room</a>
                </div>

                <div class="room-usage" id="roomUsage">
                    <span class="room-count">Rooms: <span id="currentRooms">0</span>/<span id="maxRooms">10</span></span>
                    <div id="roomLimitMessage" class="room-limit-message" style="display: none;">
                        <span>Maximum room limit reached. </span>
                        <a href="https://github.com/sebastiannicolajsen/wikirace" target="_blank">Host your own instance</a>
                    </div>
                </div>

                <a href="https://github.com/sebastiannicolajsen/wikirace" class="github-link" target="_blank">
                    <i class="fab fa-github"></i>
                    <span>Mostly vibe-coded</span>
                </a>
            </div>
        </main>
    </div>

    <script type="module">
        import popupManager from '/js/popup.js';
        import { generatePlayerName } from '/js/nameGenerator.js';
        import { initAnimatedTitle, getAnimatedTitleHTML } from '/js/animatedTitle.js';

        // Insert animated title
        document.getElementById('animatedTitle').innerHTML = getAnimatedTitleHTML();
        initAnimatedTitle();

        // Check for connection error
        const connectionError = localStorage.getItem('connectionError');
        const isCreator = sessionStorage.getItem('isCreator') === 'true';
        if (connectionError && !isCreator) {
            popupManager.showInfo(connectionError, 'error');
            localStorage.removeItem('connectionError');
        }
        sessionStorage.removeItem('isCreator');
        localStorage.removeItem('currentWikiLink');  // Clear any stored wiki link

        const form = document.getElementById('joinForm');
        const roomIdInput = document.getElementById('roomId');
        const playerNameInput = document.getElementById('playerName');
        const roleInput = document.querySelector('input[name="role"]');
        const createRoomButton = document.getElementById('createRoomButton');
        const currentRoomsSpan = document.getElementById('currentRooms');
        const maxRoomsSpan = document.getElementById('maxRooms');
        const roomLimitMessage = document.getElementById('roomLimitMessage');
        const roomUsage = document.getElementById('roomUsage');
        const buttonGroup = document.querySelector('.button-group');
        
        // Set random name as placeholder
        playerNameInput.placeholder = generatePlayerName();
        
        // Check for ID parameter in URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('id');
        if (roomId) {
            roomIdInput.value = roomId.toUpperCase();
            buttonGroup.style.display = 'none';
            roomUsage.style.display = 'none';
        } else {
            buttonGroup.style.display = 'block';
            roomUsage.style.display = 'block';
        }

        // Fetch server configuration and update room usage
        async function updateRoomUsage() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                currentRoomsSpan.textContent = config.currentRooms;
                maxRoomsSpan.textContent = config.maxRooms;
                
                // Only update room usage visibility if no roomId is present
                if (!urlParams.get('id')) {
                    // Show/hide create room button and limit message based on room count
                    if (config.currentRooms >= config.maxRooms) {
                        buttonGroup.style.display = 'none';
                        roomLimitMessage.style.display = 'block';
                    } else {
                        buttonGroup.style.display = 'block';
                        roomLimitMessage.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error fetching room usage:', error);
            }
        }

        // Update room usage initially and every 30 seconds
        updateRoomUsage();
        setInterval(updateRoomUsage, 30000);
        
        // Convert room ID to uppercase
        roomIdInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });
        
        // Handle role selection
        const roleButtonGroup = document.querySelector('.icon-button-group');
        if (roleButtonGroup) {
            roleButtonGroup.querySelectorAll('.icon-button').forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons in this group
                    roleButtonGroup.querySelectorAll('.icon-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Add active class to clicked button
                    button.classList.add('active');
                    
                    // Update hidden input value
                    roleInput.value = button.dataset.value;
                });
            });
        }
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                roomId: roomIdInput.value,
                playerName: playerNameInput.value || playerNameInput.placeholder,
                role: roleInput.value
            };

            // Store player name and type in session storage
            sessionStorage.setItem('playerName', formData.playerName);
            sessionStorage.setItem('playerType', formData.role);
            
            // Redirect to room page
            window.location.href = `/room/${formData.roomId}`;
        });

        // Handle WebSocket errors
        window.addEventListener('websocket-error', (event) => {
            popupManager.showInfo(event.detail.message, 'error');
        });
    </script>
</body>
</html> 