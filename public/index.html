<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiRace</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .room-card {
            transition: all 0.3s ease;
        }
        .room-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Initial Selection Section -->
        <div id="initialSelection" class="max-w-md mx-auto">
            <header class="text-center mb-12">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">WikiRace</h1>
            </header>
            <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert"></div>
            <div class="grid grid-cols-1 gap-4">
                <button id="createRoomBtn"
                    class="bg-blue-600 text-white py-4 px-6 rounded-lg text-xl font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Create Room
                </button>
                <button id="joinRoomBtn"
                    class="bg-green-600 text-white py-4 px-6 rounded-lg text-xl font-semibold hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    Join Room
                </button>
            </div>
        </div>

        <!-- Create Room Section (Hidden by default) -->
        <div id="createRoomSection" class="hidden max-w-md mx-auto p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-6">Create a New Room</h2>
            <form id="createForm" class="space-y-4">
                <div>
                    <label for="createPlayerName" class="block text-sm font-medium text-gray-700">Your Name</label>
                    <input type="text" id="createPlayerName" name="playerName"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Room Name</label>
                    <input type="text" id="name" name="name"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="startUrl" class="block text-sm font-medium text-gray-700">Start URL (Optional)</label>
                    <div class="mt-1 flex items-center space-x-2">
                        <button type="button" id="prevStartSuggestion" class="px-3 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            ←
                        </button>
                        <input type="text" id="startUrl" name="startUrl"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <button type="button" id="nextStartSuggestion" class="px-3 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            →
                        </button>
                    </div>
                </div>
                <div>
                    <label for="endUrl" class="block text-sm font-medium text-gray-700">End URL (Optional)</label>
                    <div class="mt-1 flex items-center space-x-2">
                        <button type="button" id="prevEndSuggestion" class="px-3 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            ←
                        </button>
                        <input type="text" id="endUrl" name="endUrl"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <button type="button" id="nextEndSuggestion" class="px-3 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            →
                        </button>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="countdownTime" class="block text-sm font-medium text-gray-700 mb-2">Countdown Time (seconds)</label>
                    <input type="range" id="countdownTime" name="countdownTime" min="5" max="35" value="30" class="w-full">
                    <div class="flex justify-between text-sm text-gray-600">
                        <span>5s</span>
                        <span id="countdownValue">30s</span>
                        <span>35s</span>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <div class="flex gap-4">
                        <button type="button" id="playerRole" class="flex items-center gap-2 px-4 py-2 rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                            </svg>
                            <span>Player</span>
                        </button>
                        <button type="button" id="observerRole" class="flex items-center gap-2 px-4 py-2 rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                            </svg>
                            <span>Observer</span>
                        </button>
                    </div>
                    <input type="hidden" name="role" value="player" id="roleInput">
                </div>
                <div>
                    <div class="flex gap-2">
                        <button type="button" id="backToSelection"
                            class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                            Back
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                            Create Room
                        </button>
                        <button type="button" id="copySettingsBtn" 
                            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
                            title="Copy settings URL">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Join Room Section (Hidden by default) -->
        <div id="joinRoomSection" class="hidden max-w-md mx-auto">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold mb-4">Join Room</h2>
                <form id="joinRoomForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Your Name</label>
                        <input type="text" id="joinPlayerName"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Room ID</label>
                        <input type="text" id="roomId" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                            placeholder="Enter 4-character room ID">
                    </div>
                    <div class="flex gap-2">
                        <button type="button" id="backToSelection2"
                            class="flex-1 bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                            Back
                        </button>
                        <button type="submit"
                            class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                            Join Room
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Waiting Room Section (Hidden by default) -->
        <div id="waitingRoom" class="hidden max-w-2xl mx-auto">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-2xl font-semibold" id="currentRoomName">Room Name</h2>
                        <div class="flex items-center gap-1">
                            <p class="text-gray-600" id="roomIdDisplay">Room ID: ABCD</p>
                            <button onclick="copyRoomLink()" 
                                    class="p-1 rounded hover:bg-gray-100 transition-colors"
                                    title="Copy room link">
                                <svg xmlns="http://www.w3.org/2000/svg" 
                                     class="w-4 h-4 text-gray-400" 
                                     viewBox="0 0 20 20" 
                                     fill="currentColor">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button id="leaveRoom"
                        class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        Leave Room
                    </button>
                </div>

                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-medium text-gray-700 mb-2">Game Details</h3>
                    <div class="space-y-2">
                        <p class="text-gray-600">Start: <span id="startTitle" class="text-blue-600 font-medium"></span></p>
                        <p class="text-gray-600">Goal: <span id="endTitle" class="text-blue-600 font-medium"></span></p>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="font-medium text-gray-700 mb-2">Players in Room</h3>
                    <div id="playerList" class="flex flex-wrap gap-2">
                        <!-- Player list will be populated here -->
                    </div>
                </div>

                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-medium text-gray-700 mb-3">Game Rules</h3>
                    <ol class="list-decimal list-inside space-y-2 text-gray-600">
                        <li>Navigate from the starting Wikipedia article to the goal article by clicking links.</li>
                        <li>After any player clicks a link, you have <span id="countdownDisplay" class="font-semibold">30</span> seconds to make your move.</li>
                        <li>If you don't select a link in time, the system will randomly choose one for you.</li>
                        <li>First to reach the goal article wins! (Multiple winners possible if reaching goal simultaneously)</li>
                    </ol>
                </div>

                <div id="creatorControls" class="mt-8">
                    <button id="startGame"
                        class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 text-lg font-semibold">
                        Start Game
                    </button>
                </div>
            </div>
        </div>

        <!-- Add this where you want to show the room creation result -->
        <div id="roomCreationResult" class="mt-4"></div>
    </div>

    <script>
        let ws = null;
        let currentRoom = null;
        let currentPlayer = null;
        let currentRole = null;
        let selectedRole = 'player'; // Default role

        // Handle URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');
        const roomId = urlParams.get('roomId');
        const playerName = urlParams.get('playerName');

        // Set form values if they exist
        if (roomId) {
            document.getElementById('roomId').value = roomId;
        }
        if (playerName) {
            document.getElementById('joinPlayerName').value = playerName;
        }

        // Display error message if present
        if (error) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.classList.remove('hidden');
            
            switch (error) {
                case 'room_not_found':
                    errorDiv.textContent = 'Room not found. Please check the room ID and try again.';
                    document.getElementById('roomId').value = ''; // Clear room ID
                    break;
                case 'name_taken':
                    errorDiv.textContent = 'This player name is already taken in the room. Please choose a different name.';
                    document.getElementById('joinPlayerName').value = ''; // Clear player name
                    break;
                case 'invalid_name':
                    errorDiv.textContent = 'Please enter a valid player name.';
                    document.getElementById('joinPlayerName').value = ''; // Clear player name
                    break;
                case 'connection_failed':
                    errorDiv.textContent = 'Failed to connect to the room. Please try again.';
                    break;
                default:
                    errorDiv.textContent = 'An error occurred. Please try again.';
            }
        }

        // Section visibility management
        function showSection(sectionId) {
            document.getElementById('initialSelection').classList.add('hidden');
            document.getElementById('createRoomSection').classList.add('hidden');
            document.getElementById('joinRoomSection').classList.add('hidden');
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // Initial selection buttons
        document.getElementById('createRoomBtn').addEventListener('click', () => showSection('createRoomSection'));
        document.getElementById('joinRoomBtn').addEventListener('click', () => showSection('joinRoomSection'));

        // Back buttons
        document.getElementById('backToSelection').addEventListener('click', () => showSection('initialSelection'));
        document.getElementById('backToSelection2').addEventListener('click', () => showSection('initialSelection'));

        // Create Room Form Handler
        const createForm = document.getElementById('createForm');
        console.log('Create form element:', createForm);

        if (createForm) {
            createForm.addEventListener('submit', async function(e) {
                console.log('Form submit event triggered');
                e.preventDefault();
                
                const playerNameInput = document.getElementById('createPlayerName');
                const playerName = playerNameInput.value.trim() || playerNameInput.placeholder;
                const roomNameInput = document.getElementById('name');
                const roomName = roomNameInput.value.trim() || roomNameInput.placeholder;
                const startUrlInput = document.getElementById('startUrl');
                const endUrlInput = document.getElementById('endUrl');
                const countdownTime = document.getElementById('countdownTime').value;
                
                console.log('Selected role before submission:', selectedRole); // Debug log
                
                // Get values or use placeholders, convert titles to URLs if needed
                let startUrl = startUrlInput.value.trim();
                let endUrl = endUrlInput.value.trim();
                
                if (!startUrl) {
                    const startSuggestion = suggestionHistory.start.suggestions[suggestionHistory.start.currentIndex];
                    startUrl = `https://en.wikipedia.org/wiki/${startSuggestion.title}`;
                } else if (!startUrl.startsWith('http')) {
                    startUrl = `https://en.wikipedia.org/wiki/${startUrl}`;
                }
                
                if (!endUrl) {
                    const endSuggestion = suggestionHistory.end.suggestions[suggestionHistory.end.currentIndex];
                    endUrl = `https://en.wikipedia.org/wiki/${endSuggestion.title}`;
                } else if (!endUrl.startsWith('http')) {
                    endUrl = `https://en.wikipedia.org/wiki/${endUrl}`;
                }
                
                console.log('Form values:', { playerName, roomName, startUrl, endUrl, role: selectedRole });
                
                try {
                    console.log('Creating room with:', { playerName, roomName, startUrl, endUrl, role: selectedRole });
                    
                    // Create the room
                    const response = await fetch('/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: roomName,
                            playerName: playerName,
                            startUrl: startUrl,
                            endUrl: endUrl,
                            countdownTime: countdownTime,
                            role: selectedRole
                        })
                    });
                    
                    console.log('Create room response:', response);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to create room');
                    }
                    
                    const data = await response.json();
                    console.log('Room created:', data);
                    
                    currentRoom = data.room;
                    currentPlayer = data.playerName;
                    currentRole = selectedRole;
                    
                    // Connect to the room
                    connectToRoom(data.room.id, data.playerName, selectedRole);
                    
                } catch (error) {
                    console.error('Error creating room:', error);
                    alert(error.message || 'Failed to create room. Please try again.');
                }
            });
        } else {
            console.error('Create form element not found');
        }

        // Join Room Form Handler
        document.getElementById('joinRoomForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const roomId = document.getElementById('roomId').value.toUpperCase();
            const playerNameInput = document.getElementById('joinPlayerName');
            const playerName = playerNameInput.value.trim() || playerNameInput.placeholder;

            if (!roomId) {
                alert('Please fill in the room ID');
                return;
            }

            // Connect to the room
            ws = new WebSocket(`ws://${window.location.host}/game/${roomId}`);

            ws.onopen = () => {
                console.log('WebSocket connected');
                // Send join message immediately after connection
                ws.send(JSON.stringify({ playerName }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WebSocket message received:', data);
                handleMessage(data);
            };

            ws.onclose = (event) => {
                console.log('WebSocket closed:', event.code, event.reason);
                // Parse the error message to determine what went wrong
                const errorMessage = event.reason;
                if (errorMessage.includes('Room not found')) {
                    // Keep player name, clear room ID
                    window.location.href = `/?error=room_not_found&playerName=${encodeURIComponent(playerName)}`;
                } else if (errorMessage.includes('Player name already taken')) {
                    // Keep room ID, clear player name
                    window.location.href = `/?error=name_taken&roomId=${encodeURIComponent(roomId)}`;
                } else if (errorMessage.includes('Valid player name is required')) {
                    // Keep room ID, clear player name
                    window.location.href = `/?error=invalid_name&roomId=${encodeURIComponent(roomId)}`;
                } else {
                    // Generic error, keep both fields
                    window.location.href = `/?error=connection_failed&roomId=${encodeURIComponent(roomId)}&playerName=${encodeURIComponent(playerName)}`;
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                // Keep existing parameters but show error
                window.location.href = `/?error=connection_failed&roomId=${encodeURIComponent(roomId)}&playerName=${encodeURIComponent(playerName)}`;
            };
        });

        // Leave Room Button Handler
        document.getElementById('leaveRoom').addEventListener('click', () => {
            if (ws) {
                ws.close();
            }
            showSection('initialSelection');
        });

        // Start Game Button Handler
        document.getElementById('startGame').addEventListener('click', () => {
            if (ws) {
                ws.send(JSON.stringify({ type: 'start_game' }));
            }
        });

        function connectToRoom(roomId, playerName, role) {
            console.log('Connecting to room with role:', role); // Debug log
            ws = new WebSocket(`ws://localhost:3000/game/${roomId}`);

            ws.onopen = () => {
                console.log('WebSocket connected');
                // Send join message immediately after connection
                const joinMessage = { 
                    type: 'join',
                    playerName: playerName,
                    role: role
                };
                console.log('Sending join message:', joinMessage);
                ws.send(JSON.stringify(joinMessage));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WebSocket message received:', data);
                handleMessage(data);
            };

            ws.onclose = () => {
                console.log('WebSocket closed');
                showSection('initialSelection');
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                alert('Failed to connect to room');
            };
        }

        function handleMessage(data) {
            console.log('Handling message:', data);
            switch (data.type) {
                case 'room_info':
                    currentRoom = data.room;
                    currentPlayer = data.playerName;
                    // If the creator is an observer, set currentRole to observer
                    currentRole = data.room.observers.includes(data.playerName) ? 'observer' : 'player';
                    console.log('Room info received:', { currentRoom, currentPlayer, currentRole });
                    updateWaitingRoom(data.room);
                    showSection('waitingRoom');
                    break;
                case 'player_joined':
                    currentRoom.players = data.players;
                    currentRoom.observers = data.observers;
                    updateWaitingRoom(data.room);
                    break;
                case 'player_left':
                    currentRoom.players = data.players;
                    currentRoom.observers = data.observers;
                    updateWaitingRoom(data.room);
                    break;
                case 'room_closed':
                    alert(data.message);
                    showSection('initialSelection');
                    break;
                case 'game_started':
                    console.log('Starting game with role:', currentRole);
                    window.location.href = `/game.html?roomId=${currentRoom.id}&playerName=${currentPlayer}&role=${currentRole}`;
                    break;
                case 'error':
                    alert(data.message);
                    break;
            }
        }

        function updateWaitingRoom(room) {
            document.getElementById('currentRoomName').textContent = room.name;
            document.getElementById('roomIdDisplay').textContent = `Room ID: ${room.id}`;
            document.getElementById('countdownDisplay').textContent = room.countdownTime;
            
            // Extract and display titles from URLs
            if (room.startUrl) {
                const startTitle = decodeURIComponent(room.startUrl.split('/wiki/').pop().replace(/_/g, ' '));
                document.getElementById('startTitle').textContent = startTitle;
            }
            if (room.endUrl) {
                const endTitle = decodeURIComponent(room.endUrl.split('/wiki/').pop().replace(/_/g, ' '));
                document.getElementById('endTitle').textContent = endTitle;
            }

            // Update player list
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';
            
            // Add players
            room.players.forEach(player => {
                const playerBadge = document.createElement('div');
                playerBadge.className = `px-3 py-1 rounded-full ${player === room.creator ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}`;
                playerBadge.textContent = player;
                if (player === room.creator) {
                    playerBadge.textContent += ' 👑';
                }
                playerList.appendChild(playerBadge);
            });
            
            // Add observers
            room.observers.forEach(observer => {
                const observerBadge = document.createElement('div');
                observerBadge.className = 'px-3 py-1 rounded-full bg-purple-100 text-purple-800';
                observerBadge.textContent = `${observer} 👁️`;
                playerList.appendChild(observerBadge);
            });

            // Show/hide creator controls
            document.getElementById('creatorControls').style.display = 
                currentPlayer === room.creator ? 'block' : 'none';
        }

        // Add suggestion history tracking
        const suggestionHistory = {
            start: {
                suggestions: [],
                currentIndex: -1
            },
            end: {
                suggestions: [],
                currentIndex: -1
            }
        };

        // Set initial suggestions when page loads
        window.onload = function() {
            const createNameInput = document.getElementById('createPlayerName');
            const joinNameInput = document.getElementById('joinPlayerName');
            const roomNameInput = document.getElementById('name');
            const startUrlInput = document.getElementById('startUrl');
            const endUrlInput = document.getElementById('endUrl');
            
            if (createNameInput) {
                createNameInput.placeholder = getRandomName();
            }
            if (joinNameInput) {
                joinNameInput.placeholder = getRandomName();
            }
            if (roomNameInput) {
                roomNameInput.placeholder = getRandomRoomName();
            }

            // Set initial URL suggestions
            getRandomPair().then(pair => {
                suggestionHistory.start.suggestions.push(pair.start);
                suggestionHistory.start.currentIndex = 0;
                startUrlInput.placeholder = pair.start.title;

                suggestionHistory.end.suggestions.push(pair.end);
                suggestionHistory.end.currentIndex = 0;
                endUrlInput.placeholder = pair.end.title;
            });
        };

        // Handle navigation buttons
        document.getElementById('prevStartSuggestion').addEventListener('click', () => {
            if (suggestionHistory.start.currentIndex > 0) {
                suggestionHistory.start.currentIndex--;
                const suggestion = suggestionHistory.start.suggestions[suggestionHistory.start.currentIndex];
                document.getElementById('startUrl').placeholder = suggestion.title;
            }
        });

        document.getElementById('nextStartSuggestion').addEventListener('click', async () => {
            const pair = await getRandomPair();
            const suggestion = pair.start;
            suggestionHistory.start.suggestions.push(suggestion);
            suggestionHistory.start.currentIndex = suggestionHistory.start.suggestions.length - 1;
            document.getElementById('startUrl').placeholder = suggestion.title;
        });

        document.getElementById('prevEndSuggestion').addEventListener('click', () => {
            if (suggestionHistory.end.currentIndex > 0) {
                suggestionHistory.end.currentIndex--;
                const suggestion = suggestionHistory.end.suggestions[suggestionHistory.end.currentIndex];
                document.getElementById('endUrl').placeholder = suggestion.title;
            }
        });

        document.getElementById('nextEndSuggestion').addEventListener('click', async () => {
            const pair = await getRandomPair();
            const suggestion = pair.end;
            suggestionHistory.end.suggestions.push(suggestion);
            suggestionHistory.end.currentIndex = suggestionHistory.end.suggestions.length - 1;
            document.getElementById('endUrl').placeholder = suggestion.title;
        });

        // Word lists for name generation
        const prefixes = [
            'Wiki',
            'Link',
            'Page',
            'Path',
            'Web',
            'Net',
            'Info',
            'Data',
            'Byte',
            'Code',
            'Tech',
            'Cyber',
            'Digital',
            'Virtual',
            'Online',
            'Cloud',
            'Pixel',
            'Binary',
            'Matrix',
            'Quantum'
        ];

        const adjectives = [
            'Swift',
            'Clever',
            'Brave',
            'Wise',
            'Quick',
            'Smart',
            'Bold',
            'Sharp',
            'Bright',
            'Nimble',
            'Agile',
            'Cunning',
            'Daring',
            'Eager',
            'Fierce',
            'Gifted',
            'Heroic',
            'Intrepid',
            'Jovial',
            'Keen',
            'Lively',
            'Mighty',
            'Noble',
            'Optimistic',
            'Powerful',
            'Quick',
            'Resourceful',
            'Strategic',
            'Tenacious',
            'Unstoppable'
        ];

        const nouns = [
            'Explorer',
            'Master',
            'Pioneer',
            'Finder',
            'Wizard',
            'Legend',
            'Pro',
            'Ninja',
            'Whiz',
            'Genius',
            'Champion',
            'Voyager',
            'Navigator',
            'Sage',
            'Mentor',
            'Guardian',
            'Warrior',
            'Scholar',
            'Virtuoso',
            'Maestro',
            'Adept',
            'Expert',
            'Guru',
            'Savant',
            'Virtuoso',
            'Pundit',
            'Sage',
            'Oracle',
            'Seeker',
            'Trailblazer'
        ];

        // Word lists for room name generation
        const roomPrefixes = [
            'The',
            'A',
            'Our',
            'Your',
            'Their',
            'My',
            'His',
            'Her',
            'This',
            'That',
            'These',
            'Those',
            'Some',
            'Any',
            'Every',
            'Each',
            'All',
            'Both',
            'Either',
            'Neither'
        ];

        const roomNouns = [
            'Journey',
            'Quest',
            'Adventure',
            'Expedition',
            'Voyage',
            'Mission',
            'Challenge',
            'Race',
            'Hunt',
            'Search',
            'Discovery',
            'Exploration',
            'Pursuit',
            'Trek',
            'Odyssey',
            'Crusade',
            'Campaign',
            'Venture',
            'Pilgrimage',
            'Safari'
        ];

        function getRandomName() {
            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            const adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            
            // Randomly decide whether to use all three parts or just two
            if (Math.random() < 0.5) {
                return `${prefix}${adjective}${noun}`;
            } else {
                return `${prefix}${noun}`;
            }
        }

        function getRandomRoomName() {
            const prefix = roomPrefixes[Math.floor(Math.random() * roomPrefixes.length)];
            const noun = roomNouns[Math.floor(Math.random() * roomNouns.length)];
            return `${prefix} ${noun}`;
        }

        // Add this function to fetch random pairs with better error handling
        async function getRandomPair() {
            try {
                const response = await fetch('/api/random-pair');
                
                if (!response.ok) {
                    throw new Error(`Failed to get random pair: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data || !data.start || !data.end) {
                    throw new Error('Invalid response format from server');
                }
                
                return data;
            } catch (error) {
                console.error('Error getting random pair:', error);
                throw error;
            }
        }

        // Update the copy function to be simpler
        function copyRoomLink() {
            const roomId = currentRoom.id;
            const shareableLink = `${window.location.origin}/?roomId=${roomId}`;
            
            navigator.clipboard.writeText(shareableLink).then(() => {
                const shareBtn = event.target.closest('button');
                const svg = shareBtn.querySelector('svg');
                
                // Show success state
                svg.style.color = '#059669';
                
                // Reset after 2 seconds
                setTimeout(() => {
                    svg.style.color = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy link:', err);
            });
        }

        // Add this function to generate the shareable URL
        function generateSettingsUrl() {
            const playerName = document.getElementById('createPlayerName').value;
            const roomName = document.getElementById('name').value;
            const startUrl = document.getElementById('startUrl').value;
            const endUrl = document.getElementById('endUrl').value;
            const countdownTime = document.getElementById('countdownTime').value;
            const role = document.getElementById('roleInput').value;

            const params = new URLSearchParams({
                playerName: playerName || document.getElementById('createPlayerName').placeholder,
                roomName: roomName || document.getElementById('name').placeholder,
                startUrl: startUrl || document.getElementById('startUrl').placeholder,
                endUrl: endUrl || document.getElementById('endUrl').placeholder,
                countdownTime: countdownTime,
                role: role
            });

            return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
        }

        // Add click handler for the copy button
        document.getElementById('copySettingsBtn').addEventListener('click', () => {
            const shareableUrl = generateSettingsUrl();
            navigator.clipboard.writeText(shareableUrl).then(() => {
                const button = document.getElementById('copySettingsBtn');
                const svg = button.querySelector('svg');
                
                // Show success state
                svg.style.color = '#059669';
                
                // Reset after 2 seconds
                setTimeout(() => {
                    svg.style.color = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy URL:', err);
            });
        });

        // Add event listener for countdown time changes
        document.getElementById('countdownTime').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('countdownValue').textContent = `${value}s`;
            document.getElementById('countdownDisplay').textContent = value;
        });

        // Update the handleUrlParameters function to also update the countdown display
        function handleUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('roomId');
            const playerName = urlParams.get('playerName');
            const roomName = urlParams.get('roomName');
            const startUrl = urlParams.get('startUrl');
            const endUrl = urlParams.get('endUrl');
            const countdownTime = urlParams.get('countdownTime');
            const role = urlParams.get('role');
            
            if (roomId) {
                // Show the join room section
                showSection('joinRoomSection');
                
                // Fill in the room ID
                const roomIdInput = document.getElementById('roomId');
                if (roomIdInput) {
                    roomIdInput.value = roomId;
                }
                
                // Focus the player name input
                const playerNameInput = document.getElementById('joinPlayerName');
                if (playerNameInput) {
                    playerNameInput.focus();
                }
            } else if (playerName || roomName || startUrl || endUrl || countdownTime || role) {
                // Show the create room section with pre-filled values
                showSection('createRoomSection');
                
                if (playerName) {
                    document.getElementById('createPlayerName').value = playerName;
                }
                if (roomName) {
                    document.getElementById('name').value = roomName;
                }
                if (startUrl) {
                    document.getElementById('startUrl').value = startUrl;
                }
                if (endUrl) {
                    document.getElementById('endUrl').value = endUrl;
                }
                if (countdownTime) {
                    document.getElementById('countdownTime').value = countdownTime;
                    document.getElementById('countdownValue').textContent = `${countdownTime}s`;
                    document.getElementById('countdownDisplay').textContent = countdownTime;
                }
                if (role) {
                    selectedRole = role;
                    document.getElementById('roleInput').value = role;
                    if (role === 'observer') {
                        document.getElementById('observerRole').classList.add('bg-blue-100', 'text-blue-700');
                        document.getElementById('observerRole').classList.remove('bg-gray-100', 'text-gray-700');
                        document.getElementById('playerRole').classList.add('bg-gray-100', 'text-gray-700');
                        document.getElementById('playerRole').classList.remove('bg-blue-100', 'text-blue-700');
                    } else {
                        document.getElementById('playerRole').classList.add('bg-blue-100', 'text-blue-700');
                        document.getElementById('playerRole').classList.remove('bg-gray-100', 'text-gray-700');
                        document.getElementById('observerRole').classList.add('bg-gray-100', 'text-gray-700');
                        document.getElementById('observerRole').classList.remove('bg-blue-100', 'text-blue-700');
                    }
                }
            }
        }

        // Call this when the page loads
        window.addEventListener('load', handleUrlParameters);

        // Add role selection handling
        document.getElementById('playerRole').addEventListener('click', () => {
            document.getElementById('playerRole').classList.add('bg-blue-100', 'text-blue-700');
            document.getElementById('playerRole').classList.remove('bg-gray-100', 'text-gray-700');
            document.getElementById('observerRole').classList.add('bg-gray-100', 'text-gray-700');
            document.getElementById('observerRole').classList.remove('bg-blue-100', 'text-blue-700');
            selectedRole = 'player';
            document.getElementById('roleInput').value = 'player';
            console.log('Role selected: player');
        });

        document.getElementById('observerRole').addEventListener('click', () => {
            document.getElementById('observerRole').classList.add('bg-blue-100', 'text-blue-700');
            document.getElementById('observerRole').classList.remove('bg-gray-100', 'text-gray-700');
            document.getElementById('playerRole').classList.add('bg-gray-100', 'text-gray-700');
            document.getElementById('playerRole').classList.remove('bg-blue-100', 'text-blue-700');
            selectedRole = 'observer';
            document.getElementById('roleInput').value = 'observer';
            console.log('Role selected: observer');
        });
    </script>
</body>
</html> 